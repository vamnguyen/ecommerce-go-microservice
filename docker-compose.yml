# Định nghĩa một mạng chung cho tất cả các service.
# Điều này cho phép chúng giao tiếp với nhau qua tên service (ví dụ: http://auth-service:9001).
networks:
  ecommerce-net:
    driver: bridge

services:
  # --- Database Auth Service ---
  auth-db:
    image: postgres:16-alpine
    container_name: auth-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=auth_db
    ports:
      - "5432:5432"
    networks:
      - ecommerce-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - auth-db-data:/var/lib/postgresql/data

  # --- Auth Service ---
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "9002:9002"
      - "9091:9090" # Metrics endpoint exposed on host 9091
    environment:
      - ENVIRONMENT=development
      - DB_HOST=auth-db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME=auth_db
      - GRPC_PORT=9002
      - JWT_PRIVATE_KEY_PATH=./certs/private_key.pem
      - JWT_PUBLIC_KEY_PATH=./certs/public_key.pem
    depends_on:
      auth-db:
        condition: service_healthy
    volumes:
      - ./auth-service/certs:/app/certs
    networks:
      - ecommerce-net

  # --- Kong API Gateway (DB-less) ---
  kong:
    image: kong:3.4
    container_name: kong
    environment:
      - KONG_DATABASE=off
      # Chỉ định đường dẫn tới file cấu hình định tuyến của Kong
      - KONG_DECLARATIVE_CONFIG=/etc/kong/kong.yml
      # Bật chế độ kiểm tra và tự động reload khi file config thay đổi
      - KONG_DECLARATIVE_CONFIG_RELOAD_INTERVAL=10s
      - KONG_PROXY_LISTEN=0.0.0.0:8000
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
    ports:
      - "8000:8000" # Cổng chính cho client truy cập vào hệ thống.
      - "8001:8001" # Cổng quản trị của Kong (để cấu hình, xem status...).
    volumes:
      - ./api-gateway/kong.yml:/etc/kong/kong.yml # Mount file cấu hình định tuyến của Kong.
      - ./auth-service/proto:/etc/kong/proto/auth # Mount auth proto
      - ./user-service/proto:/etc/kong/proto/user # Mount user proto
      - ./order-service/proto:/etc/kong/proto/order # Mount order proto
      - ./proto-common:/etc/kong/proto/google # Mount google/api proto files từ proto-common để dùng chung
    networks:
      - ecommerce-net
    restart: unless-stopped

  # --- Database User Service ---
  user-db:
    image: postgres:16-alpine
    container_name: user-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=user_db
    ports:
      - "5433:5432"
    networks:
      - ecommerce-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d user_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - user-db-data:/var/lib/postgresql/data

  # --- User Service ---
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "9003:9003"
      - "9092:9090" # Metrics endpoint
    environment:
      - ENVIRONMENT=development
      - DB_HOST=user-db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME=user_db
      - GRPC_PORT=9003
    depends_on:
      user-db:
        condition: service_healthy
    networks:
      - ecommerce-net

  # --- Database Order Service ---
  order-db:
    image: postgres:16-alpine
    container_name: order-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=order_db
    ports:
      - "5434:5432"
    networks:
      - ecommerce-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d order_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - order-db-data:/var/lib/postgresql/data

  # --- Order Service ---
  order-service:
    build:
      context: ./order-service
      dockerfile: Dockerfile
    container_name: order-service
    ports:
      - "9004:9004"
      - "9093:9090" # Metrics endpoint
    environment:
      - ENVIRONMENT=development
      - DB_HOST=order-db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME=order_db
      - GRPC_PORT=9004
      - USER_SERVICE_ADDR=user-service:9003
    depends_on:
      order-db:
        condition: service_healthy
      user-service:
        condition: service_started
    networks:
      - ecommerce-net

  # --- Observability ---
  jaeger:
    image: jaegertracing/all-in-one:1.53
    container_name: jaeger
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
    ports:
      - "16686:16686" # UI
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    networks:
      - ecommerce-net

  prometheus:
    image: prom/prometheus:v2.49.1
    container_name: prometheus
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - ecommerce-net

  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      - ecommerce-net

# Định nghĩa volumes để lưu trữ dữ liệu persistent.
volumes:
  auth-db-data:
  user-db-data:
  order-db-data:
  kong-db-data:
